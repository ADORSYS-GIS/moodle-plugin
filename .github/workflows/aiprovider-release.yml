name: AI Provider Release

on:
  push:
    tags:
      - "provider-*-v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse provider name & version
        id: parse
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"

          if [[ "$TAG" =~ ^provider-([a-zA-Z0-9_]+)-v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            PLUGIN="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"

            {
              echo "plugin_name=$PLUGIN"
              echo "version=$VERSION"
              echo "plugin_path=plugins/ai/provider/$PLUGIN"
            } >> "$GITHUB_OUTPUT"
          else
            echo "❌ Invalid tag format: $TAG"
            exit 1
          fi

      - name: Validate provider directory
        shell: bash
        run: |
          if [[ ! -d "${{ steps.parse.outputs.plugin_path }}" ]]; then
            echo "❌ Provider not found at ${{ steps.parse.outputs.plugin_path }}"
            exit 1
          fi

      - name: Package provider
        id: zip
        shell: bash
        run: |
          PLUGIN="${{ steps.parse.outputs.plugin_name }}"
          VERSION="${{ steps.parse.outputs.version }}"
          ZIP_PATH="${GITHUB_WORKSPACE}/${PLUGIN}-${VERSION}.zip"

          cd "plugins/ai/provider"

          zip -r "$ZIP_PATH" "$PLUGIN" \
            -x "$PLUGIN/node_modules/*" \
            -x "$PLUGIN/.git/*" \
            -x "$PLUGIN/.gitignore" \
            -x "$PLUGIN/yarn.lock" \
            -x "$PLUGIN/package-lock.json" \
            -x "$PLUGIN/**/.DS_Store"

          echo "zip_path=$ZIP_PATH" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ github.ref_name }}"
          name: "${{ steps.parse.outputs.plugin_name }} v${{ steps.parse.outputs.version }}"
          files: "${{ steps.zip.outputs.zip_path }}"
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
